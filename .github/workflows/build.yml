name: Build and Release

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - prerelease

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: Remove local Java path from gradle.properties
      run: sed -i 's/^org.gradle.java.home=/#&/' gradle.properties

    - name: Build with Gradle
      run: gradle clean build -x dependencyCheckAnalyze --no-daemon

    - name: List build artifacts
      run: ls -la build/libs/

    - name: Get version from gradle.properties
      id: get_version
      run: |
        VERSION=$(grep "mod_version" gradle.properties | cut -d'=' -f2)
        ARCHIVES_BASE_NAME=$(grep "archivesBaseName" build.gradle | cut -d"'" -f2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "archives_base_name=$ARCHIVES_BASE_NAME" >> $GITHUB_OUTPUT

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.get_version.outputs.archives_base_name }}-${{ steps.get_version.outputs.version }}-${{ github.sha }}
        path: build/libs/*.jar

    - name: Create Development Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: dev-${{ github.run_number }}
        name: å¼€å‘ç‰ˆæ„å»º #${{ github.run_number }}
        body: |
          ## ğŸš§ å¼€å‘ç‰ˆæ„å»º - Experience Bar Fix v${{ steps.get_version.outputs.version }}
          
          **âš ï¸ è¿™æ˜¯å¼€å‘ç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½ï¼**
          
          ### æ„å»ºä¿¡æ¯
          - ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}
          - æäº¤: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref_name }}
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          
          ### æœ€è¿‘æ›´æ”¹
          ${{ github.event.head_commit.message }}
        prerelease: true
        draft: false
        files: build/libs/${{ steps.get_version.outputs.archives_base_name }}-${{ steps.get_version.outputs.version }}.jar

    - name: Delete existing tag if exists
      if: github.event_name == 'workflow_dispatch'
      run: |
        TAG="${{ steps.get_version.outputs.tag }}"
        git tag -d "$TAG" 2>/dev/null || true
        git push origin --delete "$TAG" 2>/dev/null || true
      continue-on-error: true

    - name: Create Official Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: Experience Bar Fix ${{ steps.get_version.outputs.tag }}
        body: |
          ## ğŸ‰ Experience Bar Fix ${{ steps.get_version.outputs.tag }}
          
          ä¿®å¤ Minecraft 1.20.1 ä¼ é€åç»éªŒæ¡æ¶ˆå¤±çš„é—®é¢˜
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ”§ ä¿®å¤ä¼ é€åç»éªŒæ¡æ¶ˆå¤±çš„é—®é¢˜
          - ğŸŒ æ”¯æŒå¤šç§ä¼ é€æ–¹å¼ï¼ˆå‘½ä»¤ã€ä¼ é€é—¨ã€æœ«å½±çç ç­‰ï¼‰
          - âš™ï¸ å¯é…ç½®çš„ä¿®å¤è®¾ç½®
          - ğŸ”„ è‡ªåŠ¨é‡è¯•æœºåˆ¶ç¡®ä¿ä¿®å¤æˆåŠŸ
          
          ### ğŸ“‹ å…¼å®¹æ€§
          - âœ… Minecraft 1.20.1
          - âœ… Forge 47.2.0+
          - âœ… æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯
          
          ### ğŸ“¦ å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ä¸‹æ–¹çš„ jar æ–‡ä»¶
          2. æ”¾å…¥ mods æ–‡ä»¶å¤¹
          3. ä½¿ç”¨ Forge å¯åŠ¨ Minecraft
          
          ### ğŸ“ è®¸å¯è¯
          æœ¬é¡¹ç›®é‡‡ç”¨ GPL v3.0 å¼€æºè®¸å¯è¯
        prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}
        draft: false
        files: build/libs/${{ steps.get_version.outputs.archives_base_name }}-${{ steps.get_version.outputs.version }}.jar
        fail_on_unmatched_files: true
        generate_release_notes: true
