name: Build and Release

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_type:
        description: '发布类型'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - prerelease

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: Remove local Java path from gradle.properties
      run: sed -i 's/^org.gradle.java.home=/#&/' gradle.properties

    - name: Build with Gradle
      run: gradle clean build -x dependencyCheckAnalyze --no-daemon

    - name: List build artifacts
      run: ls -la build/libs/

    - name: Get version from gradle.properties
      id: get_version
      run: |
        VERSION=$(grep "mod_version" gradle.properties | cut -d'=' -f2)
        ARCHIVES_BASE_NAME=$(grep "archivesBaseName" build.gradle | cut -d"'" -f2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "archives_base_name=$ARCHIVES_BASE_NAME" >> $GITHUB_OUTPUT

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.get_version.outputs.archives_base_name }}-${{ steps.get_version.outputs.version }}-${{ github.sha }}
        path: build/libs/*.jar

    - name: Create Development Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: dev-${{ github.run_number }}
        name: 开发版构建 #${{ github.run_number }}
        body: |
          ## 🚧 开发版构建 - Experience Bar Fix v${{ steps.get_version.outputs.version }}
          
          **⚠️ 这是开发版本，可能包含未完全测试的功能！**
          
          ### 构建信息
          - 版本: ${{ steps.get_version.outputs.version }}
          - 提交: ${{ github.sha }}
          - 分支: ${{ github.ref_name }}
          - 构建时间: ${{ github.event.head_commit.timestamp }}
          
          ### 最近更改
          ${{ github.event.head_commit.message }}
        prerelease: true
        draft: false
        files: build/libs/${{ steps.get_version.outputs.archives_base_name }}-${{ steps.get_version.outputs.version }}.jar

    - name: Delete existing tag if exists
      if: github.event_name == 'workflow_dispatch'
      run: |
        TAG="${{ steps.get_version.outputs.tag }}"
        git tag -d "$TAG" 2>/dev/null || true
        git push origin --delete "$TAG" 2>/dev/null || true
      continue-on-error: true

    - name: Create Official Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: Experience Bar Fix ${{ steps.get_version.outputs.tag }}
        body: |
          ## 🎉 Experience Bar Fix ${{ steps.get_version.outputs.tag }}
          
          修复 Minecraft 1.20.1 传送后经验条消失的问题
          
          ### ✨ 主要功能
          - 🔧 修复传送后经验条消失的问题
          - 🌐 支持多种传送方式（命令、传送门、末影珍珠等）
          - ⚙️ 可配置的修复设置
          - 🔄 自动重试机制确保修复成功
          
          ### 📋 兼容性
          - ✅ Minecraft 1.20.1
          - ✅ Forge 47.2.0+
          - ✅ 服务端和客户端
          
          ### 📦 安装方法
          1. 下载下方的 jar 文件
          2. 放入 mods 文件夹
          3. 使用 Forge 启动 Minecraft
          
          ### 📝 许可证
          本项目采用 GPL v3.0 开源许可证
        prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}
        draft: false
        files: build/libs/${{ steps.get_version.outputs.archives_base_name }}-${{ steps.get_version.outputs.version }}.jar
        fail_on_unmatched_files: true
        generate_release_notes: true
